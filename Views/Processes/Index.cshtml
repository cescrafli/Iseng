@{
    ViewData["Title"] = "Process Explorer";
}

<div class="dashboard-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col">
                <h1>Process Explorer <span class="status-badge">LIVE</span></h1>
            </div>
            <div class="col-auto">
                <span class="text-muted small">Top 20 Consumers</span>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="card">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="procTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>User</th>
                        <th>CPU %</th>
                        <th>Mem %</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" class="text-center">Waiting for data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/monitorHub")
            .build();

        connection.on("ReceiveProcesses", function (message) {
            try {
                const procs = JSON.parse(message);
                let html = "";
                procs.forEach(function(p, index) {
                    // Stagger animation based on index
                    const delay = index * 50;
                    html += `<tr style="animation: fadeIn 0.5s ease forwards; opacity: 0; animation-delay: ${delay}ms">
                        <td><code>${p.pid}</code></td>
                        <td><b>${p.name}</b></td>
                        <td>${p.username || '-'}</td>
                        <td style="width: 200px;">
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1" style="height: 6px; margin-right: 10px;">
                                    <div class="progress-bar bg-primary" style="width:${Math.min(p.cpu_percent, 100)}%"></div>
                                </div> 
                                <span style="min-width: 40px; text-align: right;">${p.cpu_percent.toFixed(1)}%</span>
                            </div>
                        </td>
                        <td>${p.memory_percent.toFixed(1)}%</td>
                    </tr>`;
                });
                
                // Only update if row count changes or every few seconds to avoid constantly killing DOM state
                // For now, simple replacement is okay because psutil updates are 3s apart.
                const tbody = document.querySelector("#procTable tbody");
                tbody.innerHTML = html;
                
            } catch(e) { console.error(e); }
        });

        // Add CSS for fade in
        const style = document.createElement('style');
        style.textContent = `
            @@keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(style);

        connection.start();
    </script>
}
